    <!DOCTYPE html>
<html lang="en-us">
	<head>
		<script type="text/javascript">
			var host = "shuaib.me";
			if ((host == window.location.host) && (window.location.protocol != "https:"))
				window.location.protocol = "https";
		</script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="Shuaib">
		<meta name="description" content=".">
		<meta name="generator" content="Hugo 0.15" />
		<title>Visualizing Streets Clustered by Address Layout &middot; This Is Fine</title>
		<link rel="shortcut icon" href="https://shuaib.me/images/favicon.ico">
		<link rel="stylesheet" href="https://shuaib.me/css/style.css">
		<link rel="stylesheet" href="https://shuaib.me/css/highlight.css">
		<link rel="stylesheet" href="https://shuaib.me/css/monosocialiconsfont.css">
		<link rel="canonical"  href="https://shuaib.me/ars-cluster-viz/" />
		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://shuaib.me/'> <span class="arrow">←</span>Home</a>
	

	
		<a href='https://shuaib.me/about'>About</a>
	

	
</nav>

        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>Visualizing Streets Clustered by Address Layout</h1>
                    <h2 class="headline">May 1, 2019</h2>
                </header>
                <section id="post-body">
                    <p>This post is a continuation of <a href="https://shuaib.me/clustering-ars/">Clustering Address Reference Systems</a>. After running a clustering algorithm, it&rsquo;s always good to have a way of visually inspecting the clusters produced. I wanted to have an interactive plot of streets colored by their clusters assignments; where I could click on a street and its name would be displayed. You can find the notebook containing the cluster visualization code <a href="https://github.com/shuaibiyy/address-interpolation/blob/master/VisualizeStreetARS.ipynb">here</a>.</p>

<p>Essentially, we want to plot streets with colors within any axis of our choice. There are 4 main steps to getting what we want:</p>

<ol>
<li>Get the axis of a bounding box.</li>
<li>Get the names of streets within that bounding box.</li>
<li>Get the polylines for those streets.</li>
<li>Plot the polylines color-coded by their cluster assignments.</li>
</ol>

<p>Before any of the steps listed above though, we need to load the data frame containing the cluster assignments generated by K-Means algorithm in the <a href="https://shuaib.me/clustering-ars/">previous post</a>.</p>

<p><strong>1. Get the axis of a bounding box.</strong></p>

<p>To accomplish this, we use <a href="https://github.com/gboeing/osmnx">OSMnx</a>. OSMnx is a really neat python library for visualizing streets from Openstreetmap. It is easy to use, and all it takes is 2 lines to plot a street:</p>

<pre><code class="language-python">G = ox.graph_from_address('Prenzlauer Berg, Berlin, Germany', distance=1000)
fig, ax = ox.plot_graph(G, fig_height=10, fig_width=10, show=False, close=False, edge_color='#D3D3D3', node_edgecolor='#D3D3D3', node_size=25, node_zorder=3, node_color='w')
</code></pre>

<p>The polylines in step 4 below will be plotted over the axis of our OSMnx plot. This adds a nice touch of showing OSMnx network nodes.</p>

<p><strong>2. Get the names of the streets streets within that bounding box.</strong></p>

<p>To do this, we make a request to the <a href="https://overpass-turbo.eu/">Overpass API</a>. The Overpass API allows you to query OSM data. Using Overpass turned out to be rather straightforward:</p>

<pre><code class="language-python">def fetch_streets_within_bbox(min_lat, min_lon, max_lat, max_lon):
  overpass_url = &quot;http://overpass-api.de/api/interpreter&quot;
  overpass_query = f&quot;&quot;&quot;
  [out:json];
  (
   way({min_lat},{min_lon},{max_lat},{max_lon})[highway][name];
  );
  out center;
  &quot;&quot;&quot;
  response = requests.get(overpass_url,
                          params={'data': overpass_query})
  return response.json()
</code></pre>

<p><strong>3. Get the polylines for those streets.</strong></p>

<p>For that, we can use the <a href="https://github.com/pelias/polylines#download-data">polyline files</a> generated by the good folks from Pelias. <a href="https://developers.google.com/maps/documentation/utilities/polylinealgorithm">According to the creators of the polyline format</a>, &ldquo;Polyline encoding is a lossy compression algorithm that allows you to store a series of coordinates as a single string&rdquo;. We download the polyline file for Berlin streets and parse it using this function:</p>

<pre><code class="language-python">def get_polylines():
  with open('./data/berlin.polylines', 'r') as f:
    polylines = {}
    lines = f.read().splitlines()
    for l in lines:
      val, key = l.split('\0')
      existing_line = polylines[key] if key in polylines else []
      existing_line.append(val)
      polylines[key] = existing_line

    return polylines
</code></pre>

<p><strong>4. Plot the polylines colored by their cluster assignments.</strong></p>

<p>Using the axis from step 1, we iterate through all the street polylines; plot them on the axis; and color them based on their cluster assignments.</p>

<pre><code>%matplotlib notebook

text_x, _ = ax.get_xlim()
text_y, _ = ax.get_ylim()

text = ax.text(text_x, text_y, '', va='bottom', weight='bold')

plot_streets_within_axis(ax)

def on_plot_hover(event):
    for curve in ax.get_lines():
        if curve.contains(event)[0]:
            text.set_text(curve.get_gid())
            break

fig.canvas.mpl_connect('button_press_event', on_plot_hover)
</code></pre>

<p>To make the plot interactive, we specify the <em>%matplotlib notebook</em> magic command. The interactivity we want is to be able to click on any street in the plot and have its name displayed in the bottom left corner of the plot. It took me a while and the aid of some Stack Overflow answers to figure out this whole interactivity thing. At the end, we have an interactive plot that looks like this:</p>


<figure >
    
        <img src="https://rawgit.com/shuaibiyy/shuaib.me/master/themes/hugo-cactus-theme/images/ars-viz/Prenzlauer.png" alt="Streets in Prenzlauer Berg, Berlin Color-Coded by Address Layout" />
    
    
    <figcaption>
        <p>
        Streets in Prenzlauer Berg, Berlin Color-Coded by Address Layout
        
            
        
        </p> 
    </figcaption>
    
</figure>


<p>You can try out the <a href="https://github.com/shuaibiyy/address-interpolation/blob/master/VisualizeStreetARS.ipynb">notebook</a> yourself.</p>

                </section>
            </article>
            <footer id="post-meta" class="clearfix">
                <a href="https://twitter.com/shuaibiyy">
                        <img class="avatar" src="https://shuaib.me/images/avatar.png">
                        <div>
                            <span class="dark">Shuaib</span>
                            <span>Is in an endless pursuit of simplicity.</span>
                        </div>
                    </a>
                <section id="sharing">
                    <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fshuaib.me%2fars-cluster-viz%2f - Visualizing%20Streets%20Clustered%20by%20Address%20Layout by @shuaibiyy"><span class="icon-twitter"> @shuaibiyy</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

                </section>
            </footer>

            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'callmeninja';
    var disqus_identifier = 'https:\/\/shuaib.me\/ars-cluster-viz\/';
    var disqus_title = 'Visualizing Streets Clustered by Address Layout';
    var disqus_url = 'https:\/\/shuaib.me\/ars-cluster-viz\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>
    
    
        
        <li>
            <a href="https://shuaib.me/learning-to-rank-places/">Learning to Rank Places for Geospatial Search<aside class="dates">Oct 4</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/ars-cluster-viz/">Visualizing Streets Clustered by Address Layout<aside class="dates">May 1</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/clustering-ars/">Clustering Address Reference Systems<aside class="dates">Apr 30</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/adversarial-perturbations/">Learning about Adversarial Perturbations<aside class="dates">Dec 1</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/thread-db-conn-go-server/">Threading a DB Connection through a Go API Server<aside class="dates">Jan 14</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/passing-key-val-prog-args-in-code/">Passing Key-value Program Arguments to Go Programs in Code<aside class="dates">May 25</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/ecs-jenkins/">ECS-Powered Jenkins<aside class="dates">May 13</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/haproxy-config-mgmt-lambda-registry-cosmonaut/">HAProxy Configuration Management with Lambda-Registry and Cosmonaut<aside class="dates">May 8</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/immutable-infrastructure/">On Immutable Infrastructure<aside class="dates">May 6</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/overcoming-aws-ecs-deficiency-using-terraform/">Overcoming an AWS ECS Deficiency Using Terraform<aside class="dates">Apr 27</aside></a>
        </li>
        
   
</ul>
            <footer id="footer">
    
        
<div id="social">
    
    <a class="symbol" href="https://www.github.com/shuaibiyy">
        circlegithub
    </a>
    
    <a class="symbol" href="https://www.twitter.com/shuaibiyy">
        circletwitterbird
    </a>
    
</div>

    
    <p class="small">
    
        © Copyright 2020 Shuaib
    
    </p>
</footer>

        </section>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://shuaib.me/js/main.js"></script>
<script src="https://shuaib.me/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-77015490-1', 'auto');
ga('send', 'pageview');
</script>


    </body>
</html>
