    <!DOCTYPE html>
<html lang="en-us">
	<head>
		<script type="text/javascript">
			var host = "shuaib.me";
			if ((host == window.location.host) && (window.location.protocol != "https:"))
				window.location.protocol = "https";
		</script>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="Shuaib">
		<meta name="description" content=".">
		<meta name="generator" content="Hugo 0.15" />
		<title>An SSL Termination Issue in Stormpath &middot; This Is Fine</title>
		<link rel="shortcut icon" href="https://shuaib.me/images/favicon.ico">
		<link rel="stylesheet" href="https://shuaib.me/css/style.css">
		<link rel="stylesheet" href="https://shuaib.me/css/highlight.css">
		<link rel="stylesheet" href="https://shuaib.me/css/monosocialiconsfont.css">
		<link rel="canonical"  href="https://shuaib.me/stormpath-ssl-termination/" />
		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://shuaib.me/'> <span class="arrow">←</span>Home</a>
	

	
		<a href='https://shuaib.me/about'>About</a>
	

	
</nav>

        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>An SSL Termination Issue in Stormpath</h1>
                    <h2 class="headline">April 13, 2016</h2>
                </header>
                <section id="post-body">
                    <p>Our application sits behind Amazon&rsquo;s Elastic Load Balancer (ELB), which is a convenient place for terminating SSL connections. We use the Stormpath servlet plugin and its token authentication feature for our Stormpath integration. For some reason though, requests from users trying to authenticate with our application errored out with the following message:</p>

<pre><code class="language-bash">[http-listener-1(3)] DEBUG c.s.s.s.mvc.AccessTokenController - OAuth Access Token request failed.
com.stormpath.sdk.servlet.filter.oauth.OauthException: A secure HTTPS connection is required for token requests - this is a requirement of the OAuth 2 specification.
</code></pre>

<p>A look at the request headers from clients showed that <code>X-Forwarded-Proto</code> headers were getting set. The <code>X-Forwarded-Proto</code> header is responsible for informing the server of the protocol at the origin where a request was initiated. In our case, we wanted Glassfish to treat connections that had <code>X-Forwarded-Proto</code> header values of <code>https</code> as secured, so we configured it to do so. That however, still didn&rsquo;t solve the problem.</p>

<p>After some time spent in frustration and consideration of Stormpath alternatives, I found this <a href="https://github.com/stormpath/stormpath-sdk-java/issues/139">Github issue</a>, which led to the following workaround:</p>

<ol>
<li><p>Create this Factory:</p>

<pre><code class="language-java">public class SecureResolverFactory extends ConfigSingletonFactory&lt;Resolver&lt;Boolean&gt;&gt; {


    public static final String LOCALHOST_RESOLVER = &quot;stormpath.web.localhost.resolver&quot;;


    @Override
    protected Resolver&lt;Boolean&gt; createInstance(ServletContext servletContext) throws Exception {
        return new SecureForwardedProtoAwareResolver(new IsHTTPSForwardedProtoResolver(), new SecureRequiredExceptForLocalhostResolver(getConfig().getInstance(LOCALHOST_RESOLVER)));
    }
}
</code></pre></li>

<li><p>In stormpath.properties add:</p>

<pre><code class="language-bash">stormpath.web.accessToken.authorizer.secure.resolver = com.mycompany.resolver.SecureResolverFactory
</code></pre></li>

<li><p>Create these Resolvers:</p>

<pre><code class="language-java">public class IsHTTPSForwardedProtoResolver implements Resolver&lt;Boolean&gt; {


    private static final String HEADER_FORWARDED_PROTO = &quot;X-Forwarded-Proto&quot;;


    @Override
    public Boolean get(HttpServletRequest request, HttpServletResponse response) {
        String protocol = request.getHeader(HEADER_FORWARDED_PROTO);
        if (protocol != null &amp;&amp; protocol.equalsIgnoreCase(&quot;https&quot;)) {
            return true;
        }
        return false;
    }
}


public class SecureForwardedProtoAwareResolver implements Resolver&lt;Boolean&gt; {


    private final Resolver&lt;Boolean&gt; isHTTPSForwardedProtoResolver;
    private final Resolver&lt;Boolean&gt; secureRequiredExceptForLocalhostResolver;


    public SecureForwardedProtoAwareResolver(Resolver&lt;Boolean&gt; isHTTPSForwardedProtoResolver, Resolver&lt;Boolean&gt; secureRequiredExceptForLocalhostResolver) {
        Assert.notNull(isHTTPSForwardedProtoResolver, &quot;isHTTPSForwardedProtoResolver resolver cannot be null.&quot;);
        Assert.notNull(secureRequiredExceptForLocalhostResolver, &quot;secureRequiredExceptForLocalhost resolver cannot be null.&quot;);
        this.isHTTPSForwardedProtoResolver = isHTTPSForwardedProtoResolver;
        this.secureRequiredExceptForLocalhostResolver = secureRequiredExceptForLocalhostResolver;
    }


    @Override
    public Boolean get(HttpServletRequest request, HttpServletResponse response) {
        if (this.isHTTPSForwardedProtoResolver.get(request, response)) {
            return false;
        }
        return this.secureRequiredExceptForLocalhostResolver.get(request, response);
    }
}
</code></pre>

<p>That&rsquo;s it, Stormpath now considers requests with <code>X-Forwarded-Proto</code>  values of <code>https</code> as secured.</p></li>
</ol>

                </section>
            </article>
            <footer id="post-meta" class="clearfix">
                <a href="https://twitter.com/shuaibiyy">
                        <img class="avatar" src="https://shuaib.me/images/avatar.png">
                        <div>
                            <span class="dark">Shuaib</span>
                            <span>Is in an endless pursuit of simplicity.</span>
                        </div>
                    </a>
                <section id="sharing">
                    <a class="twitter" href="https://twitter.com/intent/tweet?text=https%3a%2f%2fshuaib.me%2fstormpath-ssl-termination%2f - An%20SSL%20Termination%20Issue%20in%20Stormpath by @shuaibiyy"><span class="icon-twitter"> @shuaibiyy</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

                </section>
            </footer>

            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'callmeninja';
    var disqus_identifier = 'https:\/\/shuaib.me\/stormpath-ssl-termination\/';
    var disqus_title = 'An SSL Termination Issue in Stormpath';
    var disqus_url = 'https:\/\/shuaib.me\/stormpath-ssl-termination\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            <ul id="post-list" class="archive readmore">
    <h3>Read more</h3>
    
    
        
        <li>
            <a href="https://shuaib.me/learning-to-rank-places/">Learning to Rank Places for Geospatial Search<aside class="dates">Oct 4</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/ars-cluster-viz/">Visualizing Streets Clustered by Address Layout<aside class="dates">May 1</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/clustering-ars/">Clustering Address Reference Systems<aside class="dates">Apr 30</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/adversarial-perturbations/">Learning about Adversarial Perturbations<aside class="dates">Dec 1</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/thread-db-conn-go-server/">Threading a DB Connection through a Go API Server<aside class="dates">Jan 14</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/passing-key-val-prog-args-in-code/">Passing Key-value Program Arguments to Go Programs in Code<aside class="dates">May 25</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/ecs-jenkins/">ECS-Powered Jenkins<aside class="dates">May 13</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/haproxy-config-mgmt-lambda-registry-cosmonaut/">HAProxy Configuration Management with Lambda-Registry and Cosmonaut<aside class="dates">May 8</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/immutable-infrastructure/">On Immutable Infrastructure<aside class="dates">May 6</aside></a>
        </li>
        
   
    
        
        <li>
            <a href="https://shuaib.me/overcoming-aws-ecs-deficiency-using-terraform/">Overcoming an AWS ECS Deficiency Using Terraform<aside class="dates">Apr 27</aside></a>
        </li>
        
   
</ul>
            <footer id="footer">
    
        
<div id="social">
    
    <a class="symbol" href="https://www.github.com/shuaibiyy">
        circlegithub
    </a>
    
    <a class="symbol" href="https://www.twitter.com/shuaibiyy">
        circletwitterbird
    </a>
    
</div>

    
    <p class="small">
    
        © Copyright 2020 Shuaib
    
    </p>
</footer>

        </section>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://shuaib.me/js/main.js"></script>
<script src="https://shuaib.me/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-77015490-1', 'auto');
ga('send', 'pageview');
</script>


    </body>
</html>
